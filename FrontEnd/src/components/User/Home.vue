<script>
import CAROUSEL from './Carousel.vue';
import CARDS from './Cards.vue';
import Cookie from 'js-cookie';
import { RouterLink } from "vue-router";
// Importiamo i componenti necessari di Bootstrap Vue
import {
  BNavbar,
  BNavbarBrand,
  BNavbarToggle,
  BCollapse,
  BNavbarNav,
  BNavItem,
  BNavItemDropdown,
  BDropdownItem
} from 'bootstrap-vue';

export default {
  name: 'UserHome',
  components: {
    CAROUSEL,
    CARDS,
    BNavbar,
    BNavbarBrand,
    BNavbarToggle,
    BCollapse,
    BNavbarNav,
    BNavItem,
    BNavItemDropdown,
    BDropdownItem
  },
  data() {
    return {
      events: [],
      suggEvents: [],
      sortN: true,
      sortD: false,
      arrSortN: [],
      arrSortD: [],
      userPrenotations: [],
      id_user: null
    };
  },
  created() {
    this.verifyUserType();
    this.fetchEvents();
    this.fetchSuggEvents();
    this.fetchUserPrenotations();
  },
  computed: {
    sortedEvents() {
      return this.sortN ? this.arrSortN : this.arrSortD;
    }
  },
  methods: {
    async verifyUserType() {
      try {
        const response = await fetch('http://localhost:3000/verificaUserType/test', {
          method: 'GET',
          credentials: 'include',
        });

        if (response.status === 401) {
          throw new Error('utente non loggato');
        } else if (!response.ok) {
          const errorResponse = await response.json();
          throw new Error(errorResponse.message || 'Server error');
        }
        const user_data = await response.json();
        Cookie.set('id_user', user_data._id);
        this.id_user = Cookie.get('id_user');
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    },
    fetchEvents() {
      try {
        fetch('http://localhost:3000/events', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })
            .then(response => {
              if (!response.ok) {
                throw new Error('Error fetching events');
              }
              return response.json();
            })
            .then(data => {
              this.events = data;
              Promise.all([this.sortByName(), this.sortByDate()]);
            });
      } catch (err) {
        alert(err.message);
      }
    },
    async fetchSuggEvents() {
      try {
        fetch('http://localhost:3000/suggEvents', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })
            .then(response => {
              if (!response.ok) {
                throw new Error('Error fetching events');
              }
              return response.json();
            })
            .then(data => {
              this.suggEvents = data;
            });
      } catch (err) {
        alert(err.message);
      }
    },
    async sortByName() {
      this.arrSortN = this.events.slice().sort((a, b) =>
          a.name_event.localeCompare(b.name_event)
      );
      this.sortN = true;
      this.sortD = false;
    },
    async sortByDate() {
      this.arrSortD = this.events.slice().sort((a, b) =>
          a.date_event.localeCompare(b.date_event)
      );
      this.sortD = true;
      this.sortN = false;
    },
    suggEvent() {
      this.$router.push({ path: '/SuggestionEvent' });
    },
    viewSuggEvents() {
      this.$router.push({
        path: '/SuggEvents',
        query: {
          events: this.suggEvents
        }
      });
    },
    async fetchUserPrenotations() {
      try {
        const response = await fetch(`http://localhost:3000/prenotations2?id=${Cookie.get('id_user')}`);
        if (!response.ok) {
          const errorMessage = await response.text();
          alert(`Errore dal server: ${errorMessage}`);
          return [];
        }
        const data = await response.json();
        this.userPrenotations = data.filter(p => {
          return new Date(p.date_event) <= new Date();
        });
      } catch (err) {
        alert(`Errore: ${err.message}`);
        return [];
      }
    },
    async viewForm() {
      await Promise.all([
        this.fetchUserPrenotations()
      ]);
      const today = new Date();
      const f1 = this.userPrenotations.filter(p => new Date(p.date_event) < today);
      this.$router.push({
        path: '/FormEvents',
        query: {
          events: f1
        }
      });
    },
    // Nuovo metodo per il logout
    logout() {
      Cookie.remove('id_user');
      this.$router.push('/login');
    },
    goViewBookings() {
      console.log(this.userPrenotations);
      this.$router.push({
        path: '/BookingsPage',
        query: {
          bookings: this.userPrenotations
        }
      });
    }
  }
};

</script>

<template>

  <div>
    <!-- Contenuto principale -->
    <div class="background">
      <img
          src="https://images.pexels.com/photos/571169/pexels-photo-571169.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1"
          alt="Background"
      />

      <!-- Il container si adatta in altezza al contenuto -->
      <div class="container">
        <!-- Header: il Carousel -->
        <header class="header">
          <CAROUSEL :events="events" />
        </header>

        <!-- Navbar di Bootstrap Vue -->
        <b-navbar toggleable="lg" type="dark" variant="primary" class="custom-navbar-bg">
          <b-navbar-toggle target="nav-collapse" />
          <b-collapse is-nav id="nav-collapse">
            <b-navbar-nav class="center-navbar" style="width: 100%">
              <b-nav-item @click="viewForm">Form</b-nav-item>
              <div class="separator" />
              <b-nav-item @click="suggEvent">Suggest Event</b-nav-item>
              <div class="separator" />
              <b-nav-item @click="viewSuggEvents">View Suggest Events</b-nav-item>
              <div class="separator" />
              <b-nav-item-dropdown text="Sort" right>
                <b-dropdown-item @click="sortByName">By Name</b-dropdown-item>
                <b-dropdown-item @click="sortByDate">By Date</b-dropdown-item>
              </b-nav-item-dropdown>
              <div class="separator" />
              <b-nav-item @click="goViewBookings">View Bookings</b-nav-item>
            </b-navbar-nav>
          </b-collapse>
        </b-navbar>

        <!-- Main: le Cards (la griglia degli eventi) -->
        <main class="main">
          <CARDS :events="sortedEvents" />
        </main>

        <!-- Footer (se necessario) -->
        <footer class="footer">
          <!-- Ulteriori contenuti del footer -->
        </footer>
      </div>
    </div>
  </div>
</template>

<style scoped>
  /* Sfondo: l'immagine copre lo sfondo ma non forza altezze fisse */
  .background {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .background img {
    position: absolute;
    width: 100%;
    object-fit: cover;
    z-index: -1;
  }

  /* Il container ora non ha un'altezza fissa; crescer√† in base al contenuto */
  .container {
    display: flex;
    flex-direction: column;
    width: 95%;
    margin-top: 20px;
    padding: 20px;
    background: rgb(255, 245, 238);
    border-radius: 30px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1),
    0px -4px 6px rgba(0, 0, 0, 0.1),
    4px 0px 6px rgba(0, 0, 0, 0.1),
    -4px 0px 6px rgba(0, 0, 0, 0.1);
    gap: 20px;
    min-height: 100%;
  }

  /* Header: il Carousel in cima */
  .header {
    width: 100%;
  }

  /* Main: le Cards si dispongono in base al contenuto */
  .main {
    width: 100%;
    margin-top: 10px;
  }

  /* Footer: segue il contenuto senza essere forzato a un'altezza fissa */
  .footer {
    width: 100%;
    padding: 5px;
  }

  /* Esempio di stili per eventuali bottoni personalizzati */
  button {
    cursor: pointer;
    border: 0;
    border-radius: 10px;
    font-weight: 600;
    margin: 0 10px;
    width: 70%;
    padding: 10px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1),
    0px -4px 6px rgba(0, 0, 0, 0.1),
    4px 0px 6px rgba(0, 0, 0, 0.1),
    -4px 0px 6px rgba(0, 0, 0, 0.1);
    transition: 0.4s;
  }

  .custom-navbar-bg {
    font-family: "Roboto Light", sans-serif;
    font-weight: bold;
    font-size: larger;
    background-color: rgba(104, 85, 224, 1) !important;
  }

  .center-navbar {
    display: flex;
    align-items: center;
    justify-content: space-around;
    gap: 15px;
  }

  .separator {
    height: 25px;
    width: 1px;
    background-color: rgba(255, 245, 238, 0.3);
  }

</style>
